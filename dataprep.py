import os
import glob
import cv2
import random


def process(file):

    output_path = 'train/'
    os.makedirs(output_path, exist_ok=True)
    path = '68PersonsBmp/'

    label_text = [
        "0123456789,0123456789,0123456789,12,543,4562,51853,561683,5183924,576,2462,98354,153485,5789321,69,3214,47832,478932,8963254,74,341,68421,475635,5127896,61,617,9822,842563,4180240,50,710,4500,10400,6448150,12,570,1240,59000,584100",
        "0123456789,0123456789,0123456789,57,125,4882,87235,684246,8135672,872,5324,57820,321579,8742166,87,4253,47135,515762,8103200,57,472,13032,710034,1532081,51,133,5122,871356,4231456,58,513,2012,10700,7895130,52,780,4233,15200,100000",
        "0123456789,0123456789,0123456789,78,154,8463,51235,846930,5132842,813,2135,45132,481356,4562133,84,5813,58135,572525,5713562,58,843,51563,578123,5423569,81,513,5126,845621,5753265,84,543,2132,54232,5123321,80,452,4542,50020,542155",
        "0123456789,0123456789,0123456789,21,123,5485,51267,125486,8456245,845,8452,12023,458252,5645215,51,8932,98215,513579,4895421,51,150,49216,423468,4216730,13,152,1150,499931,9015216,18,183,1112,16523,6921660,88,513,1144,51326,896125",
        "0123456789,0123456789,0123456789,81,463,1900,19212,192131,1921330,192,1892,12346,193162,1369316,22,1931,19231,164456,4346232,89,213,19213,513626,1521622,45,230,2123,212683,1296200,21,192,4523,51262,4213238,52,543,2546,45633,465125",
        "0123456789,0123456789,0123456789,20,138,8879,19597,865367,3013369,114,9499,55079,297032,7244055,60,7352,77523,280643,9108658,66,263,31618,170927,2237193,94,746,3764,625914,3160877,39,904,2673,82811,4851884,90,272,9574,42993,817566",
        "0123456789,0123456789,0123456789,64,784,1975,97059,521457,5788102,971,2643,70037,838750,1347430,24,0762,46469,028189,4126509,02,759,35394,230663,4377574,22,762,7862,625914,3160877,39,904,2673,82811,9190050,38,404,5962,94013,088266",
        "0123456789,0123456789,0123456789,80,449,6084,13965,431350,6229102,422,1908,05665,761206,1639252,84,9782,11212,643378,4177232,37,154,99161,752639,3084336,03,697,7026,823024,3485374,49,194,4584,87307,4419223,55,500,7144,72657,802405",
        "0123456789,0123456789,0123456789,06,458,1552,19093,716189,3177738,253,1360,79349,041487,2316741,71,9288,99980,642082,0307806,55,690,48646,223430,6720358,15,329,2764,159890,8830239,43,468,3104,54475,4945431,37,427,7367,85663,346136",
        "0123456789,0123456789,0123456789,39,958,5622,57767,907676,3339983,687,9435,99419,073859,2883940,46,3444,44112,634760,5499598,41,247,41091,926670,0147351,30,249,4951,043416,2525819,71,112,7002,53555,1375436,98,915,8154,68368,426139"]
    label_list = [s.split(',') for s in label_text]

    # get set idx from filename
    filename = os.path.basename(file)
    set_idx = int(filename[2:4]) - 1

    # read, convert to gray, binarized, threshold
    image = cv2.imread(path + filename)
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    blur = cv2.GaussianBlur(gray, (5, 5), 0)
    _, th = cv2.threshold(blur, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    # find contours
    cts, hs = cv2.findContours(th.copy(), cv2.RETR_CCOMP, cv2.CHAIN_APPROX_SIMPLE)

    # make bboxes of contours without child
    bboxes = []
    for id, ct in enumerate(cts):
        # only hierarchy with no child
        if hs[0, id, 2] != -1:
            (x, y, w, h) = cv2.boundingRect(ct)

            # only bb with y-axis and width limit
            if y > 300 and y < 1300 and w > 50:
                bboxes.append([x, y, x + w, y + h])

    # sort bboxes with row id then x (row id = round(y/120) )
    bboxes = sorted(bboxes, key=lambda x: (round(x[1] / 120), x[0]))

    idx = 0
    for bb in bboxes:
        x1, y1, x2, y2 = bb

        label = label_list[set_idx][idx]
        hash = random.getrandbits(128)

        cv2.imwrite(f'{output_path}{label}_{hash:032x}.jpg', image[y1 + 2:y2 - 2, x1 + 2:x2 - 2])
        idx += 1


if __name__ == '__main__':

    for f in glob.glob('68PersonsBmp/*'):
        process(f)
